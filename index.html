<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacation Tracker</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    
    <!-- PWA iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Vacation Tracker">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Maps API -->
    <script>
      function initGooglePlaces() {
        // On initialisera Google Places ici
      }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA1eDUeUhsxwo26aTQ8i7UzmN99pRezDa0&libraries=places&callback=initGooglePlaces"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 430px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Views */
        .view {
            display: none;
            min-height: calc(100vh - 60px);
        }
        
        .view.active {
            display: block;
        }
        
        /* Trips List */
        .trips-list {
            padding: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-state img {
            width: 150px;
            opacity: 0.3;
        }
        
        .empty-state h2 {
            margin-top: 20px;
            color: #666;
            font-weight: 500;
        }
        
        .trip-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .trip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        
        .trip-card-header {
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }
        
        .trip-card-content {
            padding: 16px;
        }
        
        .trip-card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .trip-card-date {
            color: #666;
            font-size: 14px;
        }
        
        /* Map View */
        #map {
            height: calc(100vh - 60px);
            width: 100%;
        }
        
        .map-controls {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            display: flex;
            gap: 12px;
            z-index: 1000;
        }
        
        .map-control-btn {
            background: #f5f5f5;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .map-control-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .map-control-btn.active {
            background: #667eea;
            color: white;
        }
        
        /* Search Bar */
        .search-container {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .search-bar {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 30px;
            background: white;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            font-size: 16px;
        }
        
        .pac-container {
            border-radius: 12px;
            margin-top: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        
        /* FAB */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 24px;
            border: none;
            z-index: 1000;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .close-btn {
            background: #f5f5f5;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .btn-primary {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background: #5a6fe0;
            transform: translateY(-1px);
        }
        
        /* Step Info */
        .step-info {
            position: absolute;
            bottom: 160px;
            left: 20px;
            right: 20px;
            background: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
        }
        
        .step-info.active {
            display: block;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        /* Responsive */
        @media (max-width: 430px) {
            .container {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 id="headerTitle">Mes Voyages</h1>
            <button class="header-btn" id="viewToggle" onclick="toggleView()">
                <svg width="24" height="24" fill="white" viewBox="0 0 24 24">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
            </button>
        </div>
        
        <!-- Trips List View -->
        <div id="tripsView" class="view active">
            <div class="trips-list">
                <div class="empty-state" id="emptyState">
                    <img src="https://api.iconify.design/fluent-emoji-flat:airplane-departure.svg" alt="Airplane">
                    <h2>Aucun voyage pour l'instant</h2>
                    <p style="color: #999; margin-top: 8px;">Appuyez sur + pour créer votre premier voyage</p>
                </div>
                <div id="tripsList"></div>
            </div>
        </div>
        
        <!-- Map View -->
        <div id="mapView" class="view">
            <div class="search-container">
                <input type="text" class="search-bar" placeholder="Rechercher un lieu..." id="searchInput">
            </div>
            <div id="map"></div>
            <div class="step-info" id="stepInfo">
                <p>Cliquez sur la carte pour ajouter une étape</p>
            </div>
            <div class="map-controls">
                <button class="map-control-btn active" onclick="setMapMode('view')">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                    </svg>
                    Voir
                </button>
                <button class="map-control-btn" onclick="setMapMode('add')">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                    </svg>
                    Ajouter
                </button>
            </div>
        </div>
        
        <!-- FAB -->
        <button class="fab" id="fab" onclick="openNewTripModal()">+</button>
        
        <!-- New Trip Modal -->
        <div id="newTripModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Nouveau Voyage</h2>
                    <button class="close-btn" onclick="closeModal('newTripModal')">&times;</button>
                </div>
                <form onsubmit="createTrip(event)">
                    <div class="form-group">
                        <label class="form-label">Nom du voyage</label>
                        <input type="text" class="form-input" id="tripName" placeholder="Ex: Road Trip Canada" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pays/Région</label>
                        <input type="text" class="form-input" id="tripCountry" placeholder="Ex: Canada" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dates</label>
                        <div class="date-inputs">
                            <input type="date" class="form-input" id="tripStartDate" required>
                            <input type="date" class="form-input" id="tripEndDate" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">Créer le voyage</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCjx3CJAEd6YZTnwvjElYl3dqFc9OthKVw",
            authDomain: "vacation-tracker-app.firebaseapp.com",
            databaseURL: "https://vacation-tracker-app-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "vacation-tracker-app",
            storageBucket: "vacation-tracker-app.firebasestorage.app",
            messagingSenderId: "1280185412299",
            appId: "1:1280185412299:web:3c7b3f3276d02ca2b9a586"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // Global variables
        let map = null;
        let currentView = 'trips';
        let currentTrip = null;
        let mapMode = 'view';
        let markers = [];
        let searchBox = null;
        let searchMarker = null;
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadTrips();
            setupMap();
        });
        
        // Initialize Google Places when API is loaded
        window.initGooglePlaces = function() {
            const input = document.getElementById('searchInput');
            const autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['geocode', 'establishment'],
                fields: ['geometry', 'name', 'formatted_address']
            });
            
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                
                if (place.geometry) {
                    // Centrer la carte sur le lieu trouvé
                    const lat = place.geometry.location.lat();
                    const lng = place.geometry.location.lng();
                    
                    map.setView([lat, lng], 15);
                    
                    // Retirer l'ancien marqueur de recherche
                    if (searchMarker) {
                        map.removeLayer(searchMarker);
                    }
                    
                    // Ajouter un marqueur temporaire
                    searchMarker = L.marker([lat, lng])
                        .addTo(map)
                        .bindPopup(place.name || place.formatted_address)
                        .openPopup();
                }
            });
        };
        
        // Load trips from Firebase
        function loadTrips() {
            const tripsRef = ref(db, 'trips');
            onValue(tripsRef, (snapshot) => {
                const data = snapshot.val();
                const tripsList = document.getElementById('tripsList');
                const emptyState = document.getElementById('emptyState');
                
                if (data) {
                    emptyState.style.display = 'none';
                    tripsList.innerHTML = '';
                    
                    Object.keys(data).forEach(tripId => {
                        const trip = data[tripId];
                        const tripCard = createTripCard(tripId, trip);
                        tripsList.appendChild(tripCard);
                    });
                } else {
                    emptyState.style.display = 'block';
                    tripsList.innerHTML = '';
                }
            });
        }
        
        // Create trip card element
        function createTripCard(tripId, trip) {
            const card = document.createElement('div');
            card.className = 'trip-card';
            card.onclick = () => openTrip(tripId, trip);
            
            const emoji = getCountryEmoji(trip.country);
            
            card.innerHTML = `
                <div class="trip-card-header">
                    ${emoji}
                </div>
                <div class="trip-card-content">
                    <div class="trip-card-title">${trip.name}</div>
                    <div class="trip-card-date">${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}</div>
                </div>
            `;
            
            return card;
        }
        
        // Get country emoji
        function getCountryEmoji(country) {
            const emojis = {
                'canada': '🇨🇦',
                'france': '🇫🇷',
                'usa': '🇺🇸',
                'états-unis': '🇺🇸',
                'espagne': '🇪🇸',
                'italie': '🇮🇹',
                'japon': '🇯🇵',
                'australie': '🇦🇺',
                'royaume-uni': '🇬🇧',
                'allemagne': '🇩🇪',
                'brésil': '🇧🇷',
                'mexique': '🇲🇽',
                'inde': '🇮🇳',
                'chine': '🇨🇳',
                'belgique': '🇧🇪',
                'suisse': '🇨🇭',
                'portugal': '🇵🇹',
                'grèce': '🇬🇷',
                'maroc': '🇲🇦',
                'thailande': '🇹🇭',
                'default': '🌍'
            };
            
            const key = country.toLowerCase();
            return emojis[key] || emojis['default'];
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        
        // Setup map
        function setupMap() {
            map = L.map('map').setView([46.603354, 1.888334], 6); // Centre sur la France
            
            // Google Maps tiles au lieu d'OpenStreetMap
            L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: '© Google Maps'
            }).addTo(map);
            
            // Click handler for adding markers
            map.on('click', (e) => {
                if (mapMode === 'add' && currentTrip) {
                    addStepAtLocation(e.latlng);
                }
            });
        }
        
        // Add step at location
        function addStepAtLocation(latlng) {
            const stepNumber = markers.length + 1;
            
            // Créer un marqueur avec numéro
            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background: #667eea; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${stepNumber}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            const marker = L.marker(latlng, {icon: icon}).addTo(map);
            marker.bindPopup(`Étape ${stepNumber}`).openPopup();
            markers.push(marker);
            
            // Tracer la ligne si il y a plus d'un marqueur
            if (markers.length > 1) {
                const latlngs = markers.map(m => m.getLatLng());
                L.polyline(latlngs, {
                    color: '#667eea',
                    weight: 4,
                    opacity: 0.6,
                    dashArray: '10, 10'
                }).addTo(map);
            }
            
            // Save to Firebase
            const stepData = {
                lat: latlng.lat,
                lng: latlng.lng,
                order: stepNumber,
                timestamp: Date.now()
            };
            
            push(ref(db, `trips/${currentTrip}/steps`), stepData);
        }
        
        // Toggle view
        window.toggleView = function() {
            if (currentView === 'trips') {
                currentView = 'map';
                document.getElementById('tripsView').classList.remove('active');
                document.getElementById('mapView').classList.add('active');
                document.getElementById('headerTitle').textContent = 'Carte';
                document.getElementById('fab').style.display = 'none';
                
                // Refresh map
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            } else {
                currentView = 'trips';
                document.getElementById('mapView').classList.remove('active');
                document.getElementById('tripsView').classList.add('active');
                document.getElementById('headerTitle').textContent = 'Mes Voyages';
                document.getElementById('fab').style.display = 'flex';
            }
        };
        
        // Set map mode
        window.setMapMode = function(mode) {
            mapMode = mode;
            document.querySelectorAll('.map-control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.map-control-btn').classList.add('active');
            
            const stepInfo = document.getElementById('stepInfo');
            if (mode === 'add' && currentTrip) {
                stepInfo.classList.add('active');
            } else {
                stepInfo.classList.remove('active');
            }
        };
        
        // Open trip
        function openTrip(tripId, trip) {
            currentTrip = tripId;
            window.toggleView(); // Switch to map view
            document.getElementById('headerTitle').textContent = trip.name;
            
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            // Clear existing polylines
            map.eachLayer((layer) => {
                if (layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });
            
            // Load trip steps
            const stepsRef = ref(db, `trips/${tripId}/steps`);
            get(stepsRef).then(snapshot => {
                const steps = snapshot.val();
                if (steps) {
                    // Convert to array and sort by order
                    const stepsArray = Object.entries(steps).map(([id, step]) => ({
                        id,
                        ...step
                    })).sort((a, b) => a.order - b.order);
                    
                    // Add markers for each step
                    stepsArray.forEach((step, index) => {
                        const icon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background: #667eea; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${index + 1}</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });
                        
                        const marker = L.marker([step.lat, step.lng], {icon: icon}).addTo(map);
                        marker.bindPopup(`Étape ${index + 1}`);
                        markers.push(marker);
                    });
                    
                    // Draw route line
                    if (markers.length > 1) {
                        const latlngs = markers.map(m => m.getLatLng());
                        L.polyline(latlngs, {
                            color: '#667eea',
                            weight: 4,
                            opacity: 0.6,
                            dashArray: '10, 10'
                        }).addTo(map);
                    }
                    
                    // Fit map to markers
                    if (markers.length > 0) {
                        const group = new L.featureGroup(markers);
                        map.fitBounds(group.getBounds().pad(0.1));
                    }
                }
            });
        }
        
        // Modal functions
        window.openNewTripModal = function() {
            document.getElementById('newTripModal').style.display = 'block';
        };
        
        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        };
        
        // Create trip
        window.createTrip = function(event) {
            event.preventDefault();
            
            const tripData = {
                name: document.getElementById('tripName').value,
                country: document.getElementById('tripCountry').value,
                startDate: document.getElementById('tripStartDate').value,
                endDate: document.getElementById('tripEndDate').value,
                createdAt: Date.now()
            };
            
            // Save to Firebase
            push(ref(db, 'trips'), tripData).then(() => {
                closeModal('newTripModal');
                document.getElementById('tripName').value = '';
                document.getElementById('tripCountry').value = '';
                document.getElementById('tripStartDate').value = '';
                document.getElementById('tripEndDate').value = '';
            });
        };
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>').value = '';
                document.getElementById('tripStartDate').value = '';
                document.getElementById('tripEndDate').value = '';
            });
        };
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>
